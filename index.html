<!DOCTYPE html>
<html>
  <head>
    <title>Google Calendar API Quickstart</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Google Calendar API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" style="display: none;">Authorize</button>
    <button id="signout_button" style="display: none;">Sign Out</button>

    <!--Add label to display server connection status-->
    <ul id="events"></ul>

    <pre id="content" style="white-space: pre-wrap;"></pre>
    <pre id="users" style="white-space: pre-wrap;"></pre>
    <pre id="emails" style="white-space: pre-wrap;"></pre>
    <pre id="calendars" style="white-space: pre-wrap;"></pre>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>

    <!--Use socket.io for real time, bidirectional and event-based communication-->
    <!--Documentation: https://socket.io/docs/-->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const $events = document.getElementById('events');

        const newItem = (content) => {
          const item = document.createElement('li');
          item.innerText = content;
          return item;
        };

        const socket = io();

        // Show server connection status on label.
        socket.on('connect', () => {
          $events.appendChild(newItem('connect'));
        });

        // Greeted by another user with data to update current new user.
        socket.on('greetNewUser', (userData) => {
          updateNewUser(userData);
        });

        // Notified of a new user joining to greet.
        socket.on('newUserJoined', (newUserData) => {
          greetNewUser(newUserData);
        });
    </script>

    <script type="text/javascript">
      // Client ID and API key from the Developer Console
	  var CLIENT_ID = '153952219009-ellvdqq4cj7esdlm4a7qv6uo8phogkbs.apps.googleusercontent.com';
	  var API_KEY = 'AIzaSyBYvGEX8vKS6jwij8l11EklPxYdaff1KOw';

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

      var authorizeButton = document.getElementById('authorize_button');
      var signoutButton = document.getElementById('signout_button');

      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
        updateView();
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        }, function(error) {
          appendPre('content', JSON.stringify(error, null, 2));
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       *  Notifies all other clients of a new user sign in.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          initMyUserData(); // initialize user data
        } else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      /**
       * Append a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} id of the pre to append
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(id, message) {
        var pre = document.getElementById(id);
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      /**
       * Replace a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} id of the pre to replace
       * @param {string} message Text to be placed in pre element.
       */
       function replacePre(id, message) {
        document.getElementById(id).innerHTML = "";
        appendPre(id, message);
      }

      /**
       * Update my user data.
       * 
       * @param {string} myUserData to update with.
       */
      function updateMyUserData(myUserData) {
        localStorage.setItem('myUserData', myUserData);
        updateAllUserData(myUserData);
      }

      /**
       * Adds user data to the collective user data array for the current user.
       * 
       * @param {string} userData to add.
       */
      function addToAllUserData(userData) {
        if (userData == null) return;

        var allUserData = JSON.parse(localStorage.getItem('allUserData')) || [];

        // Check if the user data already exists in the array.
        var index = allUserData.findIndex(x => x.userId == userData.userId);
        if (index === -1) {
          allUserData.push(JSON.parse(userData));
          localStorage.setItem('allUserData', JSON.stringify(allUserData));
        }

        updateView();
      }

      /**
       * Updates an existing user with modified data
       * 
       * @param {string} userData to update.
       */
      function updateAllUserData(userData) {
        if (userData == null) return;
        userData = JSON.parse(userData);

        var allUserData = JSON.parse(localStorage.getItem('allUserData')) || [];

        // Find the existing user to update.
        var index = allUserData.findIndex(x => x.userId == userData.userId);
        if (index === -1) return;
        allUserData[index] = userData;
        localStorage.setItem('allUserData', JSON.stringify(allUserData));

        updateView();
      }

      /**
       * Sets up the user data of the new user upon signing in.
       * 
       * Documentation: 
       * https://developers.google.com/identity/sign-in/web/reference#googleusergetid
       */
      function initMyUserData() {
        if (localStorage.getItem('myUserData') != null) return;

        const googleUser = gapi.auth2.getAuthInstance().currentUser.get();
        const profile = googleUser.getBasicProfile();
        
        gapi.client.calendar.events.list({
          'calendarId': 'primary',
          'timeMin': (new Date()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        }).then(function(response) {
          var myUserData = JSON.stringify({
            'userId': profile.getId(),
            'userName': profile.getName(),
            'email': profile.getEmail(),
            'calendar': response.result.items,
          });

          localStorage.setItem('myUserData', myUserData);
          addToAllUserData(myUserData); // add to the list of all users
          
          newUserJoined(); // broadcast to other clients that a new user joined
        });
      }

      /**
       * Emits new user's data to update all other clients' data.
       */
      function newUserJoined() {
        socket.emit('newUserJoined', localStorage.getItem('myUserData'));
      }

      /**
       * Update the new user's data with another client's data.
       * This function is called once for each client that greets the new user.
       * 
       * @param {string} userData from another user to update new user's data.
       */
      function updateNewUser(userData) {
        if (userData == localStorage.getItem('myUserData')) return;

        addToAllUserData(userData);
      }

      /**
       * Update data with new user's data.
       * Then emit user data to the new user.
       * 
       * @param {string} newUserData from new user to update current user's data.
       */
      function greetNewUser(newUserData) {
        if (newUserData == localStorage.getItem('myUserData')) return;

        addToAllUserData(newUserData);
        socket.emit('greetNewUser', localStorage.getItem('myUserData'));
      }

      /**
       * Displays the information of each user.
       * Function called on data update to re-render.
       */
      function updateView() {
        const allUserData = JSON.parse(localStorage.getItem('allUserData')) || [];

        replacePre('users', 'List of users: ');
        allUserData.forEach(userData => {
          appendPre('users', 'User: ' + userData.userId);
        });

        replacePre('emails', 'List of emails: ');
        allUserData.forEach(userData => {
          appendPre('emails', 'Email: ' + userData.email);
        });

        replacePre('calendars', 'Calendars: ');
        allUserData.forEach(userData => {
          var events = userData.calendar;

          appendPre('calendars', 'Upcoming events for userid:' + userData.userId);

          if (events.length > 0) {
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              var when = event.start.dateTime;
              if (!when) {
                when = event.start.date;
              }
              appendPre('calendars', event.summary + ' (' + when + ')')
            }
          } else {
            appendPre('calendars', 'No upcoming events found.');
          }
          
          appendPre('calendars', '\n');
        });
      }

    </script>
  </body>
</html>
